generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model Element {
  Content        String?
  Href           String?                @db.VarChar(2048)
  Id             String                 @id @map("Id")
  Name           String?                @db.VarChar(255)
  Order          Int                    @default(0)
  ParentId       String?
  Src            String?                @db.VarChar(2048)
  Styles         Json?
  TailwindStyles String?
  Type           String                 @db.VarChar(32)
  PageId         String?
  IsLocked       Boolean                @default(false)
  Page           Page?                  @relation(fields: [PageId], references: [Id], onDelete: Cascade)
  Parent         Element?               @relation("ElementChildren", fields: [ParentId], references: [Id], onDelete: Cascade)
  Elements       Element[]              @relation("ElementChildren")
  Comments       ElementComment[]
  EventWorkflows ElementEventWorkflow[]
  Settings       Setting?               @relation("ElementSettings")

  @@index([ParentId])
  @@index([PageId])
  @@index([Type])
  @@index([Order])
  @@index([IsLocked])
  @@index([PageId, Order])
  @@index([ParentId, Order])
  @@index([PageId, Type])
}

model Image {
  ImageId   String    @id(map: "PK_Images")
  ImageLink String    @default("") @db.VarChar(2048)
  ImageName String?   @db.VarChar(255)
  UserId    String
  CreatedAt DateTime  @db.Timestamp(6)
  DeletedAt DateTime? @db.Timestamp(6)
  UpdatedAt DateTime  @db.Timestamp(6)
  User      User      @relation(fields: [UserId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Images_Users_UserId")

  @@index([UserId], map: "IX_Images_UserId")
  @@index([DeletedAt])
  @@index([UserId, DeletedAt])
}

model Project {
  Description     String?
  Id              String           @id(map: "PK_Projects")
  Name            String           @db.VarChar(255)
  OwnerId         String
  Published       Boolean          @default(false)
  Subdomain       String?          @db.VarChar(63)
  CreatedAt       DateTime         @db.Timestamp(6)
  DeletedAt       DateTime?        @db.Timestamp(6)
  UpdatedAt       DateTime         @db.Timestamp(6)
  Styles          Json?
  Header          Json?
  Collaborators   Collaborator[]
  EventWorkflows  EventWorkflow[]
  Invitations     Invitation[]
  MarketplaceItem MarketplaceItem?
  Pages           Page[]
  Owner           User             @relation(fields: [OwnerId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Projects_Users_OwnerId")
  Snapshots       Snapshot[]

  @@index([OwnerId], map: "IX_Projects_OwnerId")
  @@index([Published])
  @@index([Subdomain])
  @@index([CreatedAt])
  @@index([DeletedAt])
  @@index([OwnerId, Published])
  @@index([OwnerId, DeletedAt, Published])
}

model Page {
  Id        String    @id @map("Id")
  Name      String    @db.VarChar(255)
  Type      String    @db.VarChar(50)
  Styles    Json
  ProjectId String
  CreatedAt DateTime  @db.Timestamp(6)
  UpdatedAt DateTime  @db.Timestamp(6)
  DeletedAt DateTime? @db.Timestamp(6)
  Elements  Element[]
  Project   Project   @relation(fields: [ProjectId], references: [Id], onDelete: Cascade)

  @@unique([ProjectId, Name])
  @@index([ProjectId])
  @@index([Type])
  @@index([ProjectId, Type])
}

model EventWorkflow {
  Id                    String                 @id @default(cuid())
  ProjectId             String
  Name                  String                 @db.VarChar(255)
  Description           String?
  Handlers              Json                   @default("[]")
  Enabled               Boolean                @default(true)
  CreatedAt             DateTime               @default(now()) @db.Timestamp(6)
  UpdatedAt             DateTime               @updatedAt @db.Timestamp(6)
  CanvasData            Json?
  ElementEventWorkflows ElementEventWorkflow[] @relation("ElementEventWorkflows")
  Project               Project                @relation(fields: [ProjectId], references: [Id], onDelete: Cascade)

  @@unique([ProjectId, Name])
  @@index([ProjectId])
  @@index([Enabled])
  @@index([ProjectId, Enabled])
}

model Setting {
  ElementId   String  @unique
  Id          String  @id(map: "PK_Settings")
  Name        String  @db.VarChar(255)
  SettingType String  @db.VarChar(100)
  Settings    Json
  Element     Element @relation("ElementSettings", fields: [ElementId], references: [Id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Settings_Elements_ElementId")
}

model Snapshot {
  Id        String       @id @map("Id")
  ProjectId String
  Elements  Json
  Timestamp BigInt
  CreatedAt DateTime     @default(now()) @db.Timestamp(6)
  Name      String       @db.VarChar(255)
  Type      SnapshotType
  Project   Project      @relation(fields: [ProjectId], references: [Id], onDelete: Cascade)

  @@index([ProjectId, Timestamp])
  @@index([ProjectId, Type])
  @@index([CreatedAt])
}

model User {
  CreatedAt        DateTime          @db.Timestamptz(6)
  Email            String            @db.VarChar(255) @unique
  FirstName        String?           @db.VarChar(100)
  Id               String            @id(map: "PK_Users")
  ImageUrl         String?           @db.VarChar(2048)
  LastName         String?           @db.VarChar(100)
  UpdatedAt        DateTime          @db.Timestamptz(6)
  Collaborators    Collaborator[]
  Comments         Comment[]
  CommentReactions CommentReaction[]
  CustomElements   CustomElement[]
  ElementComments  ElementComment[]
  Images           Image[]
  MarketplaceItems MarketplaceItem[]
  Notifications    Notification[]
  Projects         Project[]
  Subscriptions    Subscription[]
}

model Subscription {
  Id            String    @id @default(cuid())
  UserId        String
  PlanId        String    @db.VarChar(100)
  BillingPeriod String    @db.VarChar(50)
  Status        String    @default("pending") @db.VarChar(50)
  StartDate     DateTime  @default(now())
  EndDate       DateTime?
  Amount        Float
  Currency      String    @default("VND") @db.VarChar(10)
  CreatedAt     DateTime  @default(now()) @db.Timestamp(6)
  UpdatedAt     DateTime  @updatedAt @db.Timestamp(6)
  BankCode      String?   @db.VarChar(50)
  CardType      String?   @db.VarChar(50)
  Email         String?   @db.VarChar(255)
  PayDate       DateTime?
  TransactionNo String?   @db.VarChar(100)
  User          User      @relation(fields: [UserId], references: [Id], onDelete: Cascade)

  @@index([UserId])
  @@index([Status])
}

model ContentType {
  CreatedAt   DateTime       @default(now())
  Description String?
  Id          String         @id @default(cuid())
  Name        String         @unique @db.VarChar(255)
  UpdatedAt   DateTime       @updatedAt
  Fields      ContentField[]
  Items       ContentItem[]
}

model ContentField {
  ContentTypeId String
  Id            String              @id @default(cuid())
  Name          String              @db.VarChar(255)
  Required      Boolean             @default(false)
  Type          String              @db.VarChar(100)
  ContentType   ContentType         @relation(fields: [ContentTypeId], references: [Id], onDelete: Cascade)
  Values        ContentFieldValue[]

  @@unique([ContentTypeId, Name])
}

model ContentFieldValue {
  ContentItemId String
  FieldId       String
  Id            String       @id @default(cuid())
  Value         String?
  ContentItem   ContentItem  @relation(fields: [ContentItemId], references: [Id], onDelete: Cascade)
  Field         ContentField @relation(fields: [FieldId], references: [Id], onDelete: Cascade)

  @@unique([ContentItemId, FieldId])
}

model ContentItem {
  ContentTypeId String
  CreatedAt     DateTime            @default(now())
  Id            String              @id @default(cuid())
  Published     Boolean             @default(false)
  Slug          String              @unique @db.VarChar(255)
  Title         String              @db.VarChar(500)
  UpdatedAt     DateTime            @updatedAt
  FieldValues   ContentFieldValue[]
  ContentType   ContentType         @relation(fields: [ContentTypeId], references: [Id], onDelete: Cascade)
}

model MarketplaceItem {
  Id           String                    @id @default(cuid())
  Title        String                    @db.VarChar(500)
  Description  String
  Preview      String?                   @db.VarChar(2048)
  TemplateType String                    @default("block") @db.VarChar(50)
  Featured     Boolean                   @default(false)
  PageCount    Int?
  Downloads    Int                       @default(0)
  Likes        Int                       @default(0)
  AuthorId     String
  AuthorName   String                    @db.VarChar(255)
  Verified     Boolean                   @default(false)
  CreatedAt    DateTime                  @default(now()) @db.Timestamp(6)
  UpdatedAt    DateTime                  @updatedAt @db.Timestamp(6)
  DeletedAt    DateTime?                 @db.Timestamp(6)
  ProjectId    String?                   @unique
  Views        Int                       @default(0)
  Comments     Comment[]
  Author       User                      @relation(fields: [AuthorId], references: [Id], onDelete: Cascade)
  Project      Project?                  @relation(fields: [ProjectId], references: [Id])
  Categories   MarketplaceItemCategory[]
  Tags         MarketplaceItemTag[]

  @@index([AuthorId])
  @@index([TemplateType])
  @@index([Featured])
  @@index([ProjectId])
  @@index([CreatedAt])
  @@index([Downloads])
  @@index([Likes])
  @@index([Views])
  @@index([Featured, TemplateType])
  @@index([TemplateType, Downloads])
}

model Category {
  Id    String                    @id @default(cuid())
  Name  String                    @unique @db.VarChar(100)
  Items MarketplaceItemCategory[]
}

model Tag {
  Id    String               @id @default(cuid())
  Name  String               @unique @db.VarChar(100)
  Items MarketplaceItemTag[]
}

model MarketplaceItemTag {
  ItemId String
  TagId  String
  Item   MarketplaceItem @relation(fields: [ItemId], references: [Id], onDelete: Cascade)
  Tag    Tag             @relation(fields: [TagId], references: [Id], onDelete: Cascade)

  @@id([ItemId, TagId])
  @@index([TagId])
}

model MarketplaceItemCategory {
  ItemId     String
  CategoryId String
  Category   Category        @relation(fields: [CategoryId], references: [Id], onDelete: Cascade)
  Item       MarketplaceItem @relation(fields: [ItemId], references: [Id], onDelete: Cascade)

  @@id([ItemId, CategoryId])
  @@index([CategoryId])
}

model CustomElementType {
  Id             String          @id @default(cuid())
  Name           String          @unique @db.VarChar(255)
  Description    String?
  Category       String?         @db.VarChar(100)
  Icon           String?         @db.VarChar(255)
  CreatedAt      DateTime        @default(now()) @db.Timestamp(6)
  UpdatedAt      DateTime        @updatedAt @db.Timestamp(6)
  CustomElements CustomElement[]
}

model CustomElement {
  Id                String             @id @map("Id")
  Name              String             @db.VarChar(255)
  TypeId            String?
  Description       String?
  Category          String?            @db.VarChar(100)
  Icon              String?            @db.VarChar(255)
  Thumbnail         String?            @db.VarChar(255)
  Structure         Json
  DefaultProps      Json?
  Tags              String?            @db.VarChar(500)
  UserId            String
  IsPublic          Boolean            @default(false)
  Version           String             @default("1.0.0") @db.VarChar(20)
  CreatedAt         DateTime           @default(now()) @db.Timestamp(6)
  UpdatedAt         DateTime           @default(now()) @updatedAt @db.Timestamp(6)
  CustomElementType CustomElementType? @relation(fields: [TypeId], references: [Id])
  User              User               @relation(fields: [UserId], references: [Id], onDelete: Cascade)

  @@index([UserId])
  @@index([TypeId])
}

model Invitation {
  Id         String           @id @default(cuid())
  Email      String           @db.VarChar(255)
  ProjectId  String
  Role       CollaboratorRole @default(editor)
  Token      String           @unique @db.VarChar(255)
  ExpiresAt  DateTime
  CreatedAt  DateTime         @default(now())
  AcceptedAt DateTime?
  Status     String           @default("pending") @db.VarChar(50)
  Project    Project          @relation(fields: [ProjectId], references: [Id], onDelete: Cascade)

  @@index([ProjectId])
  @@index([Token])
  @@index([Status])
  @@index([Email])
  @@index([ExpiresAt])
  @@index([ProjectId, Status])
}

model Collaborator {
  Id        String           @id @default(cuid())
  UserId    String
  ProjectId String
  Role      CollaboratorRole @default(editor)
  CreatedAt DateTime         @default(now()) @db.Timestamp(6)
  UpdatedAt DateTime         @updatedAt @db.Timestamp(6)
  Project   Project          @relation(fields: [ProjectId], references: [Id], onDelete: Cascade)
  User      User             @relation(fields: [UserId], references: [Id], onDelete: Cascade)

  @@unique([UserId, ProjectId])
  @@index([UserId])
  @@index([ProjectId])
}

model Comment {
  Id        String            @id @default(cuid())
  Content   String
  AuthorId  String
  ItemId    String
  ParentId  String?
  Status    String            @default("published") @db.VarChar(50)
  Edited    Boolean           @default(false)
  CreatedAt DateTime          @default(now()) @db.Timestamp(6)
  UpdatedAt DateTime          @updatedAt @db.Timestamp(6)
  DeletedAt DateTime?         @db.Timestamp(6)
  Author    User              @relation(fields: [AuthorId], references: [Id], onDelete: Cascade)
  Item      MarketplaceItem   @relation(fields: [ItemId], references: [Id], onDelete: Cascade)
  Parent    Comment?          @relation("CommentReplies", fields: [ParentId], references: [Id], onDelete: Cascade)
  Replies   Comment[]         @relation("CommentReplies")
  Reactions CommentReaction[]

  @@index([AuthorId])
  @@index([ItemId])
  @@index([ParentId])
  @@index([Status])
  @@index([ItemId, Status])
  @@index([ItemId, ParentId])
  @@index([CreatedAt])
}

model CommentReaction {
  Id        String   @id @default(cuid())
  CommentId String
  UserId    String
  Type      String   @db.VarChar(50)
  CreatedAt DateTime @default(now()) @db.Timestamp(6)
  Comment   Comment  @relation(fields: [CommentId], references: [Id], onDelete: Cascade)
  User      User     @relation(fields: [UserId], references: [Id], onDelete: Cascade)

  @@index([CommentId])
  @@index([UserId])
}

model ElementComment {
  Id        String    @id @map("Id")
  Content   String
  AuthorId  String
  ElementId String
  CreatedAt DateTime  @default(now()) @db.Timestamp(6)
  UpdatedAt DateTime  @updatedAt @db.Timestamp(6)
  DeletedAt DateTime? @db.Timestamp(6)
  Resolved  Boolean   @default(false)
  Author    User      @relation(fields: [AuthorId], references: [Id], onDelete: Cascade)
  Element   Element   @relation(fields: [ElementId], references: [Id], onDelete: Cascade)

  @@index([AuthorId])
  @@index([ElementId])
  @@index([Resolved])
  @@index([ElementId, Resolved])
}

model ElementEventWorkflow {
  Id         String        @id @default(cuid())
  ElementId  String
  WorkflowId String
  EventName  String        @db.VarChar(100)
  CreatedAt  DateTime      @default(now()) @db.Timestamp(6)
  Element    Element       @relation(fields: [ElementId], references: [Id], onDelete: Cascade)
  Workflow   EventWorkflow @relation("ElementEventWorkflows", fields: [WorkflowId], references: [Id], onDelete: Cascade)

  @@unique([ElementId, WorkflowId, EventName])
  @@index([ElementId])
  @@index([WorkflowId])
  @@index([EventName])
}

model Notification {
  Id          String   @id @default(cuid())
  UserId      String
  Type        String   @db.VarChar(100)
  Title       String   @db.VarChar(500)
  Description String
  Read        Boolean  @default(false)
  CreatedAt   DateTime @default(now()) @db.Timestamp(6)
  UpdatedAt   DateTime @updatedAt @db.Timestamp(6)
  User        User     @relation(fields: [UserId], references: [Id], onDelete: Cascade)

  @@index([UserId])
  @@index([Read])
  @@index([CreatedAt])
}

enum SnapshotType {
  working
  version
}

enum CollaboratorRole {
  owner
  editor
  viewer
}
